# üó≥Ô∏è Bayrou Meter

Une application web moderne pour mesurer l'opinion publique sur Fran√ßois Bayrou avec la question : **"Est-ce que Fran√ßois Bayrou nous manque ?"**

![Architecture](docs/images/architecture-diagram.png)

## üìã Fonctionnalit√©s

### ‚úÖ Fonctionnalit√©s impl√©ment√©es

- **Identification utilisateur** : Cr√©ation d'un compte avec pseudo + email
- **Syst√®me de vote** : Vote Oui/Non √† la question sur Fran√ßois Bayrou
- **Consultation des r√©sultats** : Affichage en temps r√©el des votes et statistiques
- **Interface moderne** : UI responsive avec TailwindCSS
- **Temps r√©el** : Actualisation automatique des r√©sultats toutes les 5 secondes

## üèóÔ∏è Architecture de l'application

### Vue d'ensemble
L'application suit une architecture serverless moderne sur Azure avec s√©paration claire entre frontend et backend.

### Composants principaux

#### Frontend (React + TypeScript)
- **Framework** : React 19 avec TypeScript
- **Routage** : TanStack Router pour la navigation
- **√âtat global** : TanStack Query pour la gestion des donn√©es
- **Styling** : TailwindCSS pour l'interface utilisateur
- **Build** : Vite pour le bundling et le d√©veloppement
- **H√©bergement** : Azure Static Web Apps

#### Backend (Azure Functions)
- **Runtime** : Python 3.10
- **Architecture** : Serverless avec Azure Functions
- **API** : REST API avec endpoints CRUD
- **Authentification** : Syst√®me simple avec bcrypt pour les mots de passe

#### Base de donn√©es
- **Type** : Azure Cosmos DB (NoSQL)
- **Collections** :
  - `users` : Stockage des utilisateurs (pseudo, email, mot de passe hash√©)
  - `votes` : Stockage des votes avec r√©f√©rence utilisateur

#### Monitoring et observabilit√©
- **Application Insights** : Monitoring des performances et erreurs
- **Azure Monitor** : M√©triques syst√®me et alertes
- **Logs** : Centralisation des logs applicatifs

### Flux de donn√©es

1. **Inscription/Connexion** : L'utilisateur s'inscrit ou se connecte via le frontend
2. **Authentification** : Le backend valide les credentials et retourne les informations utilisateur
3. **Vote** : L'utilisateur soumet son vote (Oui/Non) qui est stock√© en base
4. **Consultation** : Les r√©sultats sont r√©cup√©r√©s en temps r√©el et affich√©s avec statistiques

### S√©curit√©
- Mots de passe hash√©s avec bcrypt
- Validation des donn√©es c√¥t√© backend
- CORS configur√© pour les domaines autoris√©s
- Un utilisateur ne peut voter qu'une seule fois

## üöÄ D√©marrage rapide

### Pr√©requis

- Node.js 18+
- Python 3.10+
- Azure CLI
- Azure Functions Core Tools 4.x

### Installation locale

1. **Cloner le projet**
   ```bash
   git clone <votre-repo>
   cd bayrou-meter
   ```

2. **Configuration de l'API**
   ```bash
   cd bayrou-meter-api
   cp local.settings.example.json local.settings.json
   # √âditer local.settings.json avec vos cl√©s Cosmos DB
   pip install -r requirements.txt
   ```

3. **Configuration du Frontend**
   ```bash
   cd ../frontend
   cp .env.example .env
   # √âditer .env si n√©cessaire
   npm install
   ```

4. **Lancer en d√©veloppement**
   ```bash
   # Terminal 1 - API
   cd bayrou-meter-api
   func start

   # Terminal 2 - Frontend
   cd frontend
   npm run dev
   ```

5. **Acc√©der √† l'application**
   - Frontend : http://localhost:3000
   - API : http://localhost:7071/api

## üì° API REST - Endpoints disponibles

### üîê Gestion des utilisateurs

#### `POST /api/user` - Cr√©er un utilisateur
**Description** : Inscription d'un nouvel utilisateur

**Payload** :
```json
{
  "pseudo": "string (requis)",
  "email": "string (requis, unique)",
  "password": "string (requis)"
}
```

**R√©ponse succ√®s (201)** :
```json
{
  "status": "success",
  "user": {
    "id": "uuid",
    "pseudo": "string",
    "email": "string"
  }
}
```

**Erreurs possibles** :
- `400` : Donn√©es manquantes ou invalides
- `409` : Email d√©j√† existant

#### `POST /api/login` - Connexion utilisateur
**Description** : Authentification d'un utilisateur existant

**Payload** :
```json
{
  "email": "string (requis)",
  "password": "string (requis)"
}
```

**R√©ponse succ√®s (200)** :
```json
{
  "status": "success",
  "user": {
    "id": "uuid",
    "pseudo": "string",
    "email": "string"
  }
}
```

**Erreurs possibles** :
- `400` : Donn√©es manquantes
- `401` : Email ou mot de passe incorrect

### üó≥Ô∏è Gestion des votes

#### `POST /api/vote` - Soumettre un vote
**Description** : Enregistrer le vote d'un utilisateur

**Payload** :
```json
{
  "user_id": "uuid (requis)",
  "choice": "oui|non (requis)"
}
```

**R√©ponse succ√®s (201)** :
```json
{
  "status": "success",
  "vote": {
    "id": "uuid",
    "user_id": "uuid",
    "choice": "oui|non",
    "question": "Est-ce que Fran√ßois Bayrou nous manque ?"
  }
}
```

**Erreurs possibles** :
- `400` : Donn√©es manquantes ou choix invalide
- `404` : Utilisateur non trouv√©
- `409` : L'utilisateur a d√©j√† vot√©

#### `GET /api/votes` - R√©cup√©rer les votes et statistiques
**Description** : Obtenir tous les votes avec statistiques agr√©g√©es

**R√©ponse succ√®s (200)** :
```json
{
  "votes": [
    {
      "id": "uuid",
      "user": {
        "id": "uuid",
        "pseudo": "string"
      },
      "choice": "oui|non",
      "question": "Est-ce que Fran√ßois Bayrou nous manque ?",
      "created_at": "ISO_date"
    }
  ],
  "stats": {
    "oui": 42,
    "non": 28,
    "total": 70,
    "oui_percentage": 60.0,
    "non_percentage": 40.0
  },
  "question": "Est-ce que Fran√ßois Bayrou nous manque ?"
}
```

### üìä Codes de statut HTTP
- `200` : Succ√®s
- `201` : Ressource cr√©√©e
- `400` : Requ√™te invalide
- `401` : Non autoris√©
- `404` : Ressource non trouv√©e
- `409` : Conflit (ressource d√©j√† existante)
- `500` : Erreur serveur

## üóÑÔ∏è Structure de la base de donn√©es

### Collection `users`
```json
{
  "id": "uuid",
  "pseudo": "string",
  "email": "string",
  "created_at": "ISO_date"
}
```

### Collection `votes`
```json
{
  "id": "uuid",
  "user_id": "uuid",
  "choice": "oui|non",
  "question": "Est-ce que Fran√ßois Bayrou nous manque ?",
  "created_at": "ISO_date"
}
```

## üöÄ D√©ploiement

Voir le guide d√©taill√© dans [deploy.md](./deploy.md)

### Ressources Azure n√©cessaires

- Resource Group : `BayrouMeterRG`
- Cosmos DB : `bayroudb<login>` avec base `BayrouMeterDB`
- Function App : `bayrou-api-<login>`
- Static Web App : `bayrou-frontend-<login>`
- Storage Account : `bayroustorage<login>`

## üß™ Instructions pour ex√©cuter/tester localement

### Configuration de l'environnement de d√©veloppement

#### 1. Pr√©requis syst√®me
```bash
# V√©rifier les versions
node --version  # >= 18.0.0
python --version  # >= 3.10.0
az --version  # Azure CLI
func --version  # Azure Functions Core Tools >= 4.0
```

#### 2. Configuration des variables d'environnement

**Backend (api/local.settings.json)** :
```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "",
    "FUNCTIONS_WORKER_RUNTIME": "python",
    "COSMOS_URL": "https://your-cosmos-account.documents.azure.com:443/",
    "COSMOS_KEY": "your-cosmos-primary-key"
  }
}
```

**Frontend (frontend/.env)** :
```bash
VITE_API_URL=http://localhost:7071/api
```

#### 3. Installation et d√©marrage

```bash
# 1. Cloner et installer les d√©pendances
git clone <votre-repo>
cd bayrou-meter

# 2. Backend - API
cd api
pip install -r requirements.txt
func start  # D√©marre sur http://localhost:7071

# 3. Frontend - Interface (nouveau terminal)
cd ../frontend
npm install
npm run dev  # D√©marre sur http://localhost:5173
```

### Tests manuels de l'API

#### Test complet du workflow

```bash
# 1. Cr√©er un utilisateur
curl -X POST http://localhost:7071/api/user \
  -H "Content-Type: application/json" \
  -d '{
    "pseudo": "testuser",
    "email": "test@example.com",
    "password": "motdepasse123"
  }'

# R√©ponse attendue:
# {
#   "status": "success",
#   "user": {
#     "id": "uuid-generated",
#     "pseudo": "testuser",
#     "email": "test@example.com"
#   }
# }

# 2. Se connecter
curl -X POST http://localhost:7071/api/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "motdepasse123"
  }'

# 3. Soumettre un vote (utiliser l'ID de l'√©tape 1)
curl -X POST http://localhost:7071/api/vote \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "uuid-from-step-1",
    "choice": "oui"
  }'

# 4. R√©cup√©rer les votes et statistiques
curl http://localhost:7071/api/votes
```

### Tests unitaires automatis√©s

```bash
# Ex√©cuter les tests
cd api
python -m pytest tests/ -v

# Tests avec couverture
python -m pytest tests/ --cov=. --cov-report=term-missing

# Tests sp√©cifiques
python -m pytest tests/test_integration.py -v -s
```

### V√©rification du frontend

1. **Acc√©der √† l'application** : http://localhost:5173
2. **Tester l'inscription** : Cr√©er un compte avec pseudo/email/mot de passe
3. **Tester la connexion** : Se connecter avec les credentials
4. **Tester le vote** : Soumettre un vote Oui/Non
5. **V√©rifier les r√©sultats** : Voir les statistiques en temps r√©el

### Debugging et logs

```bash
# Logs de l'API (Azure Functions)
func start --verbose

# Logs du frontend (Vite)
npm run dev -- --debug

# V√©rifier la base de donn√©es (Azure Portal)
# Aller dans Cosmos DB > Data Explorer > BayrouMeterDB
```

### Tests de performance

```bash
# Test de charge simple avec curl
for i in {1..10}; do
  curl -s http://localhost:7071/api/votes > /dev/null &
done
wait

# Ou utiliser Apache Bench
ab -n 100 -c 10 http://localhost:7071/api/votes
```

## üì∏ Captures d'√©cran du site et du monitoring Azure

### Site
![Site](docs/images/site.png)
*Interface utilisateur avec formulaire d'inscription et de connexion*

### Monitoring et observabilit√©

#### Application Insights - Vue d'ensemble
![Application Insights Overview](docs/images/azure-monitor-overview.png)
*Dashboard principal avec m√©triques de performance et sant√© de l'application*

## üìÅ Structure du projet

```
bayrou-meter/
‚îú‚îÄ‚îÄ api/                       # API Azure Functions
‚îÇ   ‚îú‚îÄ‚îÄ function_app.py        # Endpoints API
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt       # D√©pendances Python
‚îÇ   ‚îú‚îÄ‚îÄ host.json             # Configuration Functions
‚îÇ   ‚îú‚îÄ‚îÄ local.settings.example.json
‚îÇ   ‚îî‚îÄ‚îÄ tests/                # Tests unitaires et d'int√©gration
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îî‚îÄ‚îÄ test_integration.py
‚îú‚îÄ‚îÄ frontend/                  # Application React
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/       # Composants React
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lib/             # Services API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/           # Types TypeScript
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ routes/          # Pages TanStack Router
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ .env.example
‚îú‚îÄ‚îÄ .github/workflows/        # CI/CD GitHub Actions
‚îÇ   ‚îú‚îÄ‚îÄ main_bayrou-meter-api.yml
‚îÇ   ‚îî‚îÄ‚îÄ azure-static-web-apps-*.yml
‚îú‚îÄ‚îÄ docs/                     # Documentation
‚îÇ   ‚îî‚îÄ‚îÄ images/              # Captures d'√©cran
‚îú‚îÄ‚îÄ deploy.md                 # Guide de d√©ploiement
‚îî‚îÄ‚îÄ README.md                # Ce fichier
```

## üîß Technologies utilis√©es

### Frontend
- **React 19** : Framework UI
- **TanStack Router** : Routage d√©claratif
- **TanStack Query** : Gestion des donn√©es et cache
- **TailwindCSS** : Framework CSS utilitaire
- **TypeScript** : Typage statique
- **Vite** : Build tool moderne

### Backend
- **Azure Functions** : Serverless computing
- **Python 3.10** : Langage backend
- **Azure Cosmos DB** : Base NoSQL distribu√©e
- **Application Insights** : Monitoring

### DevOps et Monitoring
- **Azure CLI** : Gestion des ressources
- **GitHub Actions** : CI/CD avec tests automatis√©s
- **Application Insights** : Monitoring des performances
- **Azure Monitor** : Alertes et m√©triques syst√®me
- **Pytest** : Tests unitaires et d'int√©gration

## üöÄ CI/CD avec GitHub Actions

### Pipeline de d√©ploiement

Le projet utilise deux pipelines GitHub Actions :

#### 1. API Backend (`main_bayrou-meter-api.yml`)
```yaml
- Checkout du code
- Setup Python 3.10
- Installation des d√©pendances
- Ex√©cution des tests unitaires
- D√©ploiement vers Azure Functions
```

#### 2. Frontend (`azure-static-web-apps-*.yml`)
```yaml
- Checkout du code
- Build de l'application React
- D√©ploiement vers Azure Static Web Apps
```

### Tests automatis√©s

Les tests s'ex√©cutent automatiquement √† chaque push :

```bash
# Tests unitaires simples
python -m pytest tests/ -v

# Tests d'int√©gration (avec nettoyage automatique)
python -m pytest tests/test_integration.py -v -s
```

## üéØ Projet DevOps

Ce projet fait partie d'un exercice DevOps utilisant :
- Azure Functions pour le serverless
- Cosmos DB pour le NoSQL
- Static Web Apps pour l'h√©bergement frontend
- Application Insights pour le monitoring

**Question centrale** : "Est-ce que Fran√ßois Bayrou nous manque ?" ü§î
